<!DOCTYPE html>
<html lang="it">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8">
    <title>Oriani League</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="content"></div>

<script src="scriptDatabase.js"></script>
<script>
    async function loadPage() {
        const params = new URLSearchParams(window.location.search);
        const page = params.get("p") || "home";

        const content = document.querySelector(".content");
        content.innerHTML = "";
        if (page === "home")
            renderHome();
        else if (page === "squadre")
            await renderSquadre();
        else if (page === "gironi")
            await renderGironi();
        else if (page === "squadra")
            await renderSquadra();
        else if (page === "girone")
            await renderGirone();
    }

    async function loadAllData() {
        const [
            games,
            squadre,
            gironi,
            calciatori,
            marcatori
        ] = await Promise.all([
            loadGames(),
            loadSquadre(),
            loadGironi(),
            loadCalciatori(),
            loadMarcatori()
        ]);

        const gamesTable = document.getElementById("gamesTable");
        if (gamesTable) {
            renderGames(games, squadre);
        }

        const scorersTable = document.getElementById("scorersTable");
        if (scorersTable) {
            renderScorers(marcatori, calciatori, squadre, gironi);
        }
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // i mesi partono da 0
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');

        return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    function renderHome() {
        document.querySelector(".content").innerHTML = `
        <h1>Oriani League</h1>

        <div class="navbar">
            <a href="?p=home" class="active">Home</a>
            <a href="?p=squadre">Squadre</a>
            <a href="?p=gironi">Gironi</a>
        </div>

        <div class="columns">
            <div style="flex: 1; text-align: center;">
                <h2>Partite</h2>
                <button id="hideShow" onclick="HideShow()">Mostra tutte le partite</button>
                <table id="gamesTable" class="games-table">
                    <tr>
                        <th>Squadra 1</th>
                        <th>Gol</th>
                        <th></th>
                        <th>Gol</th>
                        <th>Squadra 2</th>
                        <th>Data</th>
                    </tr>
                </table>
            </div>

            <div style="flex: 1; text-align: center;">
                <h2>Marcatori</h2>
                <button id="top20Btn" onclick="showTop20()">Mostra Top 20</button>
                <table id="scorersTable" class="games-table">
                    <tr>
                        <th>Giocatore</th>
                        <th>Squadra</th>
                        <th>Girone</th>
                        <th>Gol</th>
                    </tr>
                </table>
            </div>
        </div>
    `;
        loadAllData()
    }

    async function renderSquadre() {
        const squads = await loadSquadre();

        document.querySelector(".content").innerHTML = `
        <h1>Oriani League</h1>

        <div class="navbar">
            <a href="?p=home">Home</a>
            <a href="?p=squadre" class="active">Squadre</a>
            <a href="?p=gironi">Gironi</a>
        </div>

        <h2 style="text-align:center;">Squadre</h2>

        <div class="teams-container" id="teamsContainer"></div>
    `;

        const container = document.getElementById("teamsContainer");

        squads.forEach(t => {
            console.log(t['nome'].toLowerCase().replaceAll(' ', '').replaceAll('#', ''))
            const el = document.createElement("a");
            el.href = `?p=squadra&id=${t.id}`;
            el.className = "team-card";
            el.innerHTML = `
            <div class="team-logo">
                <img src="./images/${t['nome'].toLowerCase().replaceAll(' ', '').replaceAll('#', '')}.jpg" alt="${t.nome} Logo" onerror="this.onerror=null; this.src='./images/logo-placeholder.png';">
            </div>
            <div class="team-name">${t.nome}</div>
        `;
            container.appendChild(el);
        });
    }

    async function renderSquadra() {
        const params = new URLSearchParams(window.location.search);
        const id = Number(params.get("id"));

        const [
            squadre,
            gironi,
            games
        ] = await Promise.all([
            loadSquadre(),
            loadGironi(),
            loadGames()
        ]);

        const squadra = squadre.find(s => s.id === id);

        if (!squadra) {
            document.querySelector(".content").innerHTML = `
            <h2 style="text-align:center; color:red;">Squadra non trovata!</h2>
        `;
            return;
        }

        const girone = gironi.find(g => g.id === squadra.girone);

        const squadreGirone = squadre
            .filter(s => s.girone === squadra.girone)
            .sort((a, b) => {
                if (a.punti !== b.punti) return b.punti - a.punti;
                return b.differenza_reti - a.differenza_reti;
            });

        const partite = games
            .filter(g => {
                const t1 = squadre.find(s => s.id === g.id1)?.nome;
                const t2 = squadre.find(s => s.id === g.id2)?.nome;
                return t1 === squadra.nome || t2 === squadra.nome;
            })
            .map(g => {
                return {
                    ...g,
                    team1: squadre.find(s => s.id === g.id1)?.nome ?? "???",
                    team2: squadre.find(s => s.id === g.id2)?.nome ?? "???"
                };
            }).sort((a, b) => new Date(a.orario) - new Date(b.orario));

        const content = document.querySelector(".content");
        content.innerHTML = `
        <h1>Oriani League</h1>

        <div class="navbar">
            <a href="?p=home">Home</a>
            <a href="?p=squadre" class="active">Squadre</a>
            <a href="?p=gironi">Gironi</a>
        </div>

        <div style="margin:20px 0 0 20px;">
            <a href="index.html?p=squadre"
                style="display:inline-block;padding:8px 16px;background:#2e6bf9;color:white;text-decoration:none;border-radius:8px;font-weight:bold;transition:0.2s;">
                ⟵ Torna indietro
            </a>
        </div>

        <h2 style="text-align:center;">${squadra.nome}</h2>

        <div style="text-align:center;">
            <img src="images/logo-placeholder.png"
                 alt="${squadra.nome} Logo"
                 style="width:150px; height:150px;">
        </div>

        <h2 style="text-align:center; margin-top:20px;">Informazioni Squadra</h2>

        <p style="margin-top: 20px; text-align: center; font-size:16px;">
            Girone ${girone.nome}
        </p>

        <div class="columns">
            <div style="flex:1;">
                <h2 style="text-align:center;">Classifica Girone</h2>
                <table style="width:100%; border-collapse: collapse; text-align: center;">
                    <tr style="background:#2e6bf9; color:white;">
                        <th>Pos</th>
                        <th>Squadra</th>
                        <th>Punti</th>
                        <th>Differenza Reti</th>
                    </tr>

                    ${squadreGirone.map((s, i) => `
                        <tr style="background:${s.id === squadra.id ? '#f0f8ff' : 'white'};">
                            <td>${i+1}</td>
                            <td>${s.nome}</td>
                            <td>${s.punti}</td>
                            <td>${s.differenza_reti}</td>
                        </tr>
                    `).join("")}
                </table>
            </div>

            <div style="flex:1;">
                <h2 style="text-align:center;">Partite</h2>
                <table style="width:100%; border-collapse: collapse; text-align:center;">
                    <tr style="background:#2e6bf9; color:white;">
                        <th>Squadra 1</th>
                        <th>Gol</th>
                        <th>-</th>
                        <th>Gol</th>
                        <th>Squadra 2</th>
                        <th>Data</th>
                    </tr>

                    ${partite.map(g => {
            const played = g.gol1 !== null && g.gol2 !== null;
            const won =
                played &&
                ((g.team1 === squadra.nome && g.gol1 > g.gol2) ||
                    (g.team2 === squadra.nome && g.gol2 > g.gol1));
            const draw = played && g.gol1 === g.gol2;
            const loss = played && !won && !draw;

            let bg = "white";
            if (played && won) bg = "#d4edda";
            else if (played && draw) bg = "#fff3b3";
            else if (played && loss) bg = "#f8d7da";

            return `
                            <tr style="background:${bg};">
                                <td>${g.team1}</td>
                                <td>${g.gol1 ?? ""}</td>
                                <td>-</td>
                                <td>${g.gol2 ?? ""}</td>
                                <td>${g.team2}</td>
                                <td>${formatDate(g.orario)}</td>
                            </tr>
                        `;
        }).join("")}
                </table>
            </div>

        </div>
    `;
    }

    async function renderGironi() {
        const [gironi, squadre] = await Promise.all([
            loadGironi(),
            loadSquadre()
        ]);

        const gironiData = gironi.map(g => {
            const teamsInGirone = squadre.filter(s => s.girone == g.id);

            teamsInGirone.sort((a, b) => {
                if (a.punti !== b.punti) return b.punti - a.punti;
                return b.differenza_reti - a.differenza_reti;
            });

            return {
                id: g.id,
                nome: g.nome,
                classifica: teamsInGirone,
                punti: g.punti
            };
        });

        document.querySelector(".content").innerHTML = `
        <h1>Oriani League</h1>

        <div class="navbar">
            <a href="?p=home">Home</a>
            <a href="?p=squadre">Squadre</a>
            <a href="?p=gironi" class="active">Gironi</a>
        </div>

        <h2 style="text-align:center;">Gironi</h2>

        <div class="teams-container" id="gironiContainer"></div>
    `;

        const container = document.getElementById("gironiContainer");

        gironiData.forEach(g => {
            const card = document.createElement("a");
            card.href = `?p=girone&id=${g.id}`;
            card.className = "team-card";
            card.style.height = "auto";
            card.style.padding = "15px";

            const top4 = g.classifica.slice(0, 4);

            card.innerHTML = `
            <div class="team-name" style="font-size:22px; margin-bottom:10px;">
                ${g.nome}
            </div>

            <table style="width:100%; font-size:14px; text-align:center; border-collapse: collapse;">
                <tr style="font-weight:bold;">
                    <td>#</td>
                    <td>Squadra</td>
                    <td>P</td>
                </tr>
                ${top4
                .map((t, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${t.nome}</td>
                            <td>${t.punti}</td>
                        </tr>
                    `)
                .join("")}
            </table>
        `;

            container.appendChild(card);
        });
    }

    async function renderGirone() {
        const params = new URLSearchParams(window.location.search);
        const id = Number(params.get("id"));
        if (!id) return;

        const [
            gironi, squadre, games, marcatori, calciatori
        ] = await Promise.all([
            loadGironi(),
            loadSquadre(),
            loadGames(),
            loadMarcatori(),
            loadCalciatori()
        ]);

        const girone = gironi.find(g => g.id === id);
        if (!girone) {
            document.querySelector(".content").innerHTML = `<h2 style="text-align:center; color:red;">Girone non trovato.</h2>`;
            return;
        }

        const squadreGirone = squadre
            .filter(s => s.girone === id)
            .sort((a, b) => b.punti - a.punti || b.differenza_reti - a.differenza_reti);

        const partite = games.filter(g => {
            const t1 = squadre.find(s => s.id === g.id1)?.nome;
            const t2 = squadre.find(s => s.id === g.id2)?.nome;
            return squadreGirone.some(s => s.nome === t1 || s.nome === t2);
        }).map(g => ({
            ...g,
            team1: squadre.find(s => s.id === g.id1)?.nome ?? "???",
            team2: squadre.find(s => s.id === g.id2)?.nome ?? "???"
        })).sort((a, b) => new Date(a.orario) - new Date(b.orario));

        const marcatoriGirone = marcatori
            .map(m => {
                const c = calciatori.find(c => c.id === m.calciatore);
                const s = squadre.find(s => s.id === c.squadra);
                if (s.girone !== id) return null;
                return { giocatore: c.nome, squadra: s.nome, gol: m.gol };
            })
            .filter(x => x)
            .reduce((acc, curr) => {
                const existing = acc.find(a => a.giocatore === curr.giocatore);
                if (existing) existing.gol += curr.gol;
                else acc.push(curr);
                return acc;
            }, [])
            .sort((a, b) => b.gol - a.gol);

        const content = document.querySelector(".content");
        content.innerHTML = `
        <h1>Oriani League</h1>
        <div class="navbar">
            <a href="?p=home">Home</a>
            <a href="?p=squadre">Squadre</a>
            <a href="?p=gironi" class="active">Gironi</a>
        </div>
        <div style="margin:20px 0 0 20px;">
            <a href="?p=gironi" style="display:inline-block;padding:8px 16px;background:#2e6bf9;color:white;text-decoration:none;border-radius:8px;font-weight:bold;">
                ⟵ Torna indietro
            </a>
        </div>
        <h2 style="text-align:center;">${girone.nome}</h2>
        <div class="columns" ">
            <div style="flex:1;">
                <h2 style="text-align:center;">Classifica</h2>
                <table style="width:100%; border-collapse: collapse; border: solid 1px black; text-align:center;">
                    <tr style="background:#2e6bf9; color:white;">
                        <th>Pos</th>
                        <th>Squadra</th>
                        <th>Punti</th>
                        <th>Diff</th>
                    </tr>
                    ${squadreGirone.map((s, i) => `
                        <tr style="border: solid 1px black;">
                            <td>${i+1}</td>
                            <td><a href="?p=squadra&id=${s.id}" style="text-decoration:none;color:black;">${s.nome}</a></td>
                            <td>${s.punti}</td>
                            <td>${s.differenza_reti}</td>
                        </tr>`).join('')}
                </table>
            </div>
            <div style="flex:1;">
                <h2 style="text-align:center;">Partite</h2>
                <table style="width:100%; border-collapse: collapse; border: solid 1px black; text-align:center; background: white">
                    <tr style="background:#2e6bf9; color:white;">
                        <th>Squadra 1</th>
                        <th>Gol</th>
                        <th>-</th>
                        <th>Gol</th>
                        <th>Squadra 2</th>
                        <th>Data</th>
                    </tr>
                    ${partite.map(g => `
                        <tr style="border: solid 1px black;">
                            <td>${g.team1}</td>
                            <td>${g.gol1 ?? ''}</td>
                            <td>-</td>
                            <td>${g.gol2 ?? ''}</td>
                            <td>${g.team2}</td>
                            <td>${formatDate(g.orario)}</td>
                        </tr>`).join('')}
                </table>
            </div>
        </div>
        <div style="max-width:800px; margin:40px auto;">
            <h2 style="text-align:center;">Classifica Marcatori</h2>
            <table style="width:100%; border-collapse: collapse; text-align:center; border: solid 1px black;">
                <tr style="background:#2e6bf9; color:white;">
                    <th>Giocatore</th>
                    <th>Squadra</th>
                    <th>Gol</th>
                </tr>
                ${marcatoriGirone.map(m => `
                    <tr style="border: solid 1px black;">
                        <td>${m.giocatore}</td>
                        <td>${m.squadra}</td>
                        <td>${m.gol}</td>
                    </tr>`).join('')}
            </table>
        </div>
    `;
    }

    let showAllGames = false;
    let allGamesCache = [];
    let allSquadreCache = [];

    function renderGames(games, squadre) {
        allGamesCache = games;
        allSquadreCache = squadre;

        const table = document.getElementById("gamesTable");

        const now = new Date();
        const oneWeekAgo = new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000);
        const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

        let list = showAllGames
            ? games
            : games.filter(g => new Date(g.orario) >= oneWeekAgo && new Date(g.orario) <= nextWeek);

        list.sort((a, b) => new Date(a.orario) - new Date(b.orario));

        list.forEach(g => {
            const team1 = squadre.find(s => s.id === g.id1)?.nome ?? "???";
            const team2 = squadre.find(s => s.id === g.id2)?.nome ?? "???";

            const played = g.gol1 !== null && g.gol2 !== null;
            const className = played ? "played" : "not-played";

            const tr = document.createElement("tr");
            tr.className = className;

            tr.innerHTML = `
            <td>${team1}</td>
            <td>${g.gol1 ?? ""}</td>
            <td>-</td>
            <td>${g.gol2 ?? ""}</td>
            <td>${team2}</td>
            <td>${formatDate(g.orario)}</td>
        `;

            table.appendChild(tr);
        });
    }

    function renderScorers(marcatori, calciatori, squadre, gironi) {
        const table = document.getElementById("scorersTable");

        const map = {};

        marcatori.forEach(m => {
            if (!map[m.calciatore]) map[m.calciatore] = 0;
            map[m.calciatore] += m.gol;
        });

        const rows = Object.entries(map)
            .map(([id, gol]) => {
                const c = calciatori.find(x => x.id === Number(id));
                const s = squadre.find(x => x.id === c.squadra);
                const g = gironi.find(x => x.id === s.girone);

                return {
                    giocatore: c.nome,
                    squadra: s.nome,
                    girone: g.nome,
                    gol
                };
            })
            .sort((a, b) => b.gol - a.gol);

        rows.forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>${r.giocatore}</td>
            <td>${r.squadra}</td>
            <td>${r.girone}</td>
            <td>${r.gol}</td>
        `;
            table.appendChild(tr);
        });

        showTop20()
    }

    function HideShow() {
        showAllGames = !showAllGames;

        document.getElementById("hideShow").innerHTML =
            showAllGames ? "Mostra ultime partite" : "Mostra tutte le partite";

        renderGames(allGamesCache, allSquadreCache);
    }

    let showingTop20 = false;
    function showTop20() {
        const table = document.getElementById('scorersTable');
        const rows = Array.from(table.querySelectorAll('tr')).slice(1);

        if (!showingTop20) {
            rows.forEach((r, i) => r.style.display = i < 20 ? '' : 'none');
            document.getElementById('top20Btn').innerText = 'Mostra tutti';
        } else {
            rows.forEach(r => r.style.display = '');
            document.getElementById('top20Btn').innerText = 'Mostra Top 20';
        }

        showingTop20 = !showingTop20;
    }

    loadPage();
</script>

<footer>
    <div style="max-width: 1200px; margin: 0 auto;">
        <p>Oriani League © 2025 | Fatto da Savogpt</p>
        <p>Email: nun me scassa u cazz | Tel: 104 676 7104</p>
        <p>
            <a href="#" style="color:white; text-decoration:underline; margin:0 5px;">Privacy</a> |
            <a href="#" style="color:white; text-decoration:underline; margin:0 5px;">Termini</a>
        </p>
    </div>
</footer>
</body>
</html>